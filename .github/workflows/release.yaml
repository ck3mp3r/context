name: Release

on:
  workflow_dispatch:

permissions:
  packages: write
  contents: write
  actions: read
  checks: read
  deployments: read
  issues: read
  pull-requests: read
  id-token: write

jobs:
  prep-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.prep.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Setup Nu Tools
        uses: ck3mp3r/actions/nu-tools@main

      - name: Prepare release
        id: prep
        shell: nu {0}
        run: |
          use nu-tools *
          setup-git-user

          # Create placeholder dist/ folder for rust-embed compile-time check
          # The real frontend build happens later in the build job
          mkdir dist
          echo '<!DOCTYPE html><html><body>Placeholder for rust-embed</body></html>' | save dist/index.html

          let current_version = (open Cargo.toml).package.version
          let latest_tag = (get-latest-tag)
          let version = (semver-calculate $latest_tag $current_version | create-release-branch)
          update-cargo-version $version | commit-files $"Prepare release ($version)"
          $"version=($version)" | save --append $env.GITHUB_OUTPUT

  build:
    needs: prep-release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            nix_system: x86_64-linux
            docker_arch: amd64
          - os: macos-15
            nix_system: x86_64-darwin
            docker_arch: na
          - os: macos-15
            nix_system: aarch64-darwin
            docker_arch: na
          - os: ubuntu-24.04-arm
            nix_system: aarch64-linux
            docker_arch: arm64
    steps:
      - name: Checkout release branch
        uses: actions/checkout@v6
        with:
          ref: release/${{ needs.prep-release.outputs.version }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21

      - name: Build archive for ${{ matrix.nix_system }}
        run: nix build .#archive --print-build-logs

      - name: Copy build outputs for uniqueness
        run: |
          # Archive package creates generic filenames, so we rename them with system suffix
          cp result/context.tgz ${{ github.workspace }}/context-${{ needs.prep-release.outputs.version }}-${{ matrix.nix_system }}.tgz
          cp result/context.sha256 ${{ github.workspace }}/context-${{ needs.prep-release.outputs.version }}-${{ matrix.nix_system }}.sha256
          cp result/context-nix.sha256 ${{ github.workspace }}/context-${{ needs.prep-release.outputs.version }}-${{ matrix.nix_system }}-nix.sha256

      - name: Upload build outputs as artifacts
        uses: actions/upload-artifact@v6
        with:
          name: context-assets-${{ matrix.nix_system }}
          path: |
            ${{ github.workspace }}/context-${{ needs.prep-release.outputs.version }}-${{ matrix.nix_system }}.tgz
            ${{ github.workspace }}/context-${{ needs.prep-release.outputs.version }}-${{ matrix.nix_system }}.sha256
            ${{ github.workspace }}/context-${{ needs.prep-release.outputs.version }}-${{ matrix.nix_system }}-nix.sha256

      - name: Log in to GHCR
        uses: docker/login-action@v3
        if: ${{ matrix.docker_arch != 'na' }}
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ${{ matrix.nix_system }} container
        if: ${{ matrix.docker_arch != 'na' }}
        run: |
          VERSION=${{ needs.prep-release.outputs.version }}
          nix build .#container --system ${{ matrix.nix_system }} && cat result | docker load

          docker tag context:${VERSION} ghcr.io/${{ github.repository_owner }}/context:${VERSION}-${{ matrix.docker_arch }}
          docker push ghcr.io/${{ github.repository_owner }}/context:${VERSION}-${{ matrix.docker_arch }}

  finalize-release:
    needs:
      - prep-release
      - build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v2
        id: token
        with:
          app-id: ${{ secrets.BOT_ID }}
          private-key: ${{ secrets.BOT }}

      - name: Checkout release branch
        uses: actions/checkout@v6
        with:
          ref: release/${{ needs.prep-release.outputs.version }}
          fetch-depth: 0
          token: ${{ steps.token.outputs.token }}

      - name: Setup Nu Tools
        uses: ck3mp3r/actions/nu-tools@main

      - name: Download all build artifacts
        uses: actions/download-artifact@v7
        with:
          path: ./artifacts

      - name: Finalize release
        shell: nu {0}
        run: |
          use nu-tools *
          setup-git-user

          let version = "${{ needs.prep-release.outputs.version }}"

          # Generate platform data and commit
          generate-platform-data-for $version "context" "./artifacts" | commit-files $"Add platform data for release ($version)"

          # Prepare architecture data with hashes
          let architectures = [
            {
              name: "aarch64-darwin"
              hash: (open $"./artifacts/context-assets-aarch64-darwin/context-($version)-aarch64-darwin.sha256" | str trim)
            }
            {
              name: "aarch64-linux"
              hash: (open $"./artifacts/context-assets-aarch64-linux/context-($version)-aarch64-linux.sha256" | str trim)
            }
            {
              name: "x86_64-darwin"
              hash: (open $"./artifacts/context-assets-x86_64-darwin/context-($version)-x86_64-darwin.sha256" | str trim)
            }
            {
              name: "x86_64-linux"
              hash: (open $"./artifacts/context-assets-x86_64-linux/context-($version)-x86_64-linux.sha256" | str trim)
            }
          ]

          # Update Homebrew formula
          open Formula/context.rb | update-homebrew-formula $version "context" $architectures | save --force Formula/context.rb

          # Commit the formula update
          ["Formula/context.rb"] | commit-files $"Update Homebrew formula for ($version)"

          # Merge and cleanup
          merge-and-cleanup $version

          # Create release and upload artifacts using gh CLI
          create-github-release $version
          glob "./artifacts/**/*.*" | upload-release-artifacts $version

        env:
          GITHUB_TOKEN: ${{ steps.token.outputs.token }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push multi-arch manifests
        run: |
          VERSION=${{ needs.prep-release.outputs.version }}
          REPO=ghcr.io/${{ github.repository_owner }}/context

          # Pull architecture-specific images
          docker pull $REPO:$VERSION-amd64
          docker pull $REPO:$VERSION-arm64

          # Create versioned multi-arch manifest
          docker manifest create $REPO:$VERSION \
            $REPO:$VERSION-amd64 \
            $REPO:$VERSION-arm64
          docker manifest push $REPO:$VERSION

          docker manifest create $REPO:latest --amend \
            $REPO:$VERSION-amd64 \
            $REPO:$VERSION-arm64
          docker manifest push $REPO:latest
